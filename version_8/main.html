<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë§Œì˜ ë“œë¦¼ ëƒ‰ì¥ê³ </title>
    <link rel="stylesheet" href="main.css"> <!-- ë©”ì¸ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" href="shelf.css"> <!-- ì„ ë°˜ ìŠ¤íƒ€ì¼ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- jQuery í¬í•¨ -->
    <!-- ì•Œë¦¼ ê´€ë ¨ CSS ì—°ê²° -->
    <link rel="stylesheet" href="notification.css">
    <!-- íŒì—… ì—´ê¸° ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="popup.js"></script>
</head>
<body>
    <div class="header">
        <h1 class="title">ë‚˜ë§Œì˜ ë“œë¦¼ ëƒ‰ì¥ê³ </h1>
    </div>
    <div class="main-container">
            <!-- ëƒ‰ë™/ëƒ‰ì¥ì‹¤ -->
            <div class="fridge-open">
                <!-- ëƒ‰ë™ì‹¤ -->
                <div id="freeze-section" class="shelf-container">
                    <h2 class="section-title">ëƒ‰ë™ì‹¤</h2>
                    <div id="freeze-shelves-container" class="scroll-container">
                        <div id="todayFreeze" class="freeze-section"></div>
                        <div id="freeze-shelves" class="freeze-section"></div>
                    </div>
                </div>
                <!-- ëƒ‰ì¥ì‹¤ -->
                <div id="fridge-section" class="shelf-container">
                    <h2 class="section-title">ëƒ‰ì¥ì‹¤</h2>
                    <div id="freeze-shelves-container" class="scroll-container">
                        <div id="todayFridge" class="fridge-section"></div>
                        <div id="fridge-shelves" class="fridge-section"></div>
                    </div>
                </div>
            </div>
            <!-- ì¢… ì•„ì´ì½˜ -->
            <div class="notification-icon" onclick="toggleNotification()">
                ğŸ””
            </div>
            <!-- ì•Œë¦¼ ê´€ë ¨ JS ì—°ê²° -->
            <script src="notification.js"></script>
            <!-- ì•Œë¦¼ íŒì—… -->
            <div class="notification-popup" id="notificationPopup">
                <div class="popup-header">
                    <span>ì•Œë¦¼</span>
                    <button class="close-btn" onclick="toggleNotification()">âœ–</button>
                </div>
                <div class="popup-content">
                    <div id="call"></div>
                </div>
            </div>
            <div class="down-open">
                <div class="recipe-container">
                    <h2 class="recipe-title">ì¶”ì²œ ìš”ë¦¬</h2>
                    <div id="receipt-shelves" class = "receipt-section"></div>
                </div>
                <button id="use-btn" class="use-btn">ì‚¬ìš©</button> <!-- ì¶”ì²œ ë ˆì‹œí”¼ì˜ ì‚¬ìš© ë²„íŠ¼ -->
                <button id="change-btn" class="register-btn">ì¬ë£Œ ë“±ë¡í•˜ê¸°</button>
            </div>
    </div>
</body>

    <!-- ë™ì  ë°ì´í„° ë¡œë“œ ë° ì´ë²¤íŠ¸ ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        let buttonsVisible = false; // ë²„íŠ¼ì´ í˜„ì¬ í‘œì‹œ ì¤‘ì¸ì§€ ìƒíƒœë¥¼ ì €ì¥

        async function loadIngredients() {
            try {
                const response = await fetch('http://localhost:3000/ingredients'); // API í˜¸ì¶œ
                const data = await response.json();
                document.getElementById('todayFridge').innerHTML = '';
                document.getElementById('fridge-shelves').innerHTML = '';
                document.getElementById('todayFreeze').innerHTML = '';
                document.getElementById('freeze-shelves').innerHTML = '';
                // ëƒ‰ì¥ì‹¤ ë°ì´í„° ì¶”ê°€
                const fridgeContainer = document.getElementById('fridge-shelves');
                data.fridge.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shelf';
                    itemDiv.setAttribute('id',item.id)
                    itemDiv.innerHTML = `
                        <img src="${item.image || 'path/to/default_image.jpg'}">
                        <div class="name">${item.name}</div>
                        <div class="expiry-date">ìœ í†µê¸°í•œ: ${item.expirationDate.split('T')[0]}</div>
                        <div class="usage-count">ì‚¬ìš©íšŸìˆ˜: ${item.uses || 0}íšŒ</div>
                    `;
                    fridgeContainer.appendChild(itemDiv);
                });

                // ëƒ‰ë™ì‹¤ ë°ì´í„° ì¶”ê°€
                const freezeContainer = document.getElementById('freeze-shelves');
                data.freeze.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shelf';
                    itemDiv.setAttribute('id',item.id)
                    itemDiv.innerHTML = `
                        <img src="${item.image || 'path/to/default_image.jpg'}">
                        <div class="name">${item.name}</div>
                        <div class="expiry-date">ìœ í†µê¸°í•œ: ${item.expirationDate.split('T')[0]}</div>
                        <div class="usage-count">ì‚¬ìš©íšŸìˆ˜: ${item.uses || 0}íšŒ</div>
                    `;
                    freezeContainer.appendChild(itemDiv);
                });
                // ì˜¤ëŠ˜ ì¶”ê°€í•œ ëƒ‰ì¥ ì‹í’ˆ
                const todayFridgeContainer = document.getElementById('todayFridge');
                data.todayFridge.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shelf';
                    itemDiv.setAttribute('id',item.id)
                    itemDiv.innerHTML = `
                        <img src="${item.image || 'path/to/default_image.jpg'}">
                        <div class="name">${item.name}</div>
                        <div class="expiry-date">ìœ í†µê¸°í•œ: ${item.expirationDate.split('T')[0]}</div>
                        <div class="usage-count">ì‚¬ìš©íšŸìˆ˜: ${item.uses || 0}íšŒ</div>
                    `;
                    todayFridgeContainer.appendChild(itemDiv);
                });
                const todayFreezeContainer = document.getElementById('todayFreeze');
                data.todayFreeze.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shelf';
                    itemDiv.setAttribute('id',item.id)
                    itemDiv.innerHTML = `
                        <img src="${item.image || 'path/to/default_image.jpg'}">
                        <div class="name">${item.name}</div>
                        <div class="expiry-date">ìœ í†µê¸°í•œ: ${item.expirationDate.split('T')[0]}</div>
                        <div class="usage-count">ì‚¬ìš©íšŸìˆ˜: ${item.uses || 0}íšŒ</div>
                    `;
                    todayFreezeContainer.appendChild(itemDiv);
                });
            } catch (error) {
                console.error('Error loading ingredients:', error);
                alert('ì¬ë£Œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function loadreceipts() {
            try {
                const response = await fetch('http://localhost:3000/receipts'); // API í˜¸ì¶œ
                const data = await response.json();
                const receiptContainer = document.getElementById('receipt-shelves');
                const ingredientsArray = data.ingredients.trim().split('\n');

                const itemsPerRow = 2; // í•œ ì¤„ì— í‘œì‹œí•  í•­ëª© ìˆ˜
                let currentRow = ''; // í˜„ì¬ ì¤„ì˜ ë‚´ìš©ì„ ì €ì¥
                receiptContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš©ì„ ì´ˆê¸°í™”

                ingredientsArray.forEach((item, index) => {
                    currentRow += `${item.trim()}     `; // í•­ëª© ì¶”ê°€ (5ì¹¸ ê³µë°± í¬í•¨)

                    // í˜„ì¬ ì¤„ì´ ê½‰ ì°¼ê±°ë‚˜ ë§ˆì§€ë§‰ í•­ëª©ì¸ ê²½ìš° ì¶œë ¥
                    if ((index + 1) % itemsPerRow === 0 || index === ingredientsArray.length - 1) {
                        const rowDiv = document.createElement('div'); // ìƒˆ ì¤„ ìƒì„±
                        rowDiv.style.whiteSpace = 'pre-wrap'; // ê³µë°± ìœ ì§€
                        rowDiv.textContent = currentRow.trim(); // í˜„ì¬ ì¤„ì˜ ë‚´ìš©ì„ ì¶”ê°€
                        receiptContainer.appendChild(rowDiv); // ì¤„ì„ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
                        currentRow = ''; // í˜„ì¬ ì¤„ ì´ˆê¸°í™”
                    }
                });

            } catch (error) {
                console.error('Error loading receipt:', error);
                alert('ë ˆì‹œí”¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }


        // ì•ŒëŒ ë°ì´í„° ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
        $.get('http://localhost:3000/getIngredients', function(data) {
            console.log(data);  // ë°ì´í„°ê°€ ì˜ ë°›ì•„ì¡ŒëŠ”ì§€ í™•ì¸

            if (data.length > 0) {
                let notificationContent = '<ul>';
                data.forEach(function(ingredient) {
                    notificationContent += `<li>${ingredient.name}: ${ingredient.remainingDays}ì¼ ë‚¨ìŒ</li>`;
                });
                notificationContent += '</ul>';
                $('#call').html(notificationContent);
            } else {
                $('#call').html('ë‚¨ì€ ìœ íš¨ê¸°ê°„ì´ 3ì¼ ì´í•˜ì¸ ì¬ë£Œê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.log('ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨:', textStatus, errorThrown);
            $('#call').html('ì„œë²„ë¡œë¶€í„° ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });

        // ì¶”ì²œ ë ˆì‹œí”¼ì˜ "ì‚¬ìš©" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            const useButton = document.getElementById('use-btn');
            useButton.addEventListener('click', () => {
                // ë²„íŠ¼ ìƒíƒœì— ë”°ë¼ ì¶”ê°€ ë˜ëŠ” ì œê±°
                if (!buttonsVisible) {
                    // ë²„íŠ¼ì´ ì—†ëŠ” ìƒíƒœ -> ì¶”ê°€
                    document.querySelectorAll('.shelf').forEach(shelf => {
                        addActionButtons(shelf);
                    });
                } else {
                    // ë²„íŠ¼ì´ ìˆëŠ” ìƒíƒœ -> ì œê±°
                    document.querySelectorAll('.shelf .action-btn-container').forEach(container => {
                        container.remove();
                    });
                }
                buttonsVisible = !buttonsVisible; // ìƒíƒœ í† ê¸€
            });
        });

        // ë²„íŠ¼ 1ê³¼ ë²„íŠ¼ 2ë¥¼ ì„ ë°˜ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        function addActionButtons(shelf) {
            // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìƒì„±
            const btnContainer = document.createElement('div');
            btnContainer.className = 'action-btn-container'; // ì‹ë³„ì„ ìœ„í•œ í´ë˜ìŠ¤
            btnContainer.style.display = 'flex';
            btnContainer.style.gap = '10px';
            btnContainer.style.marginTop = '10px';

            // ì²« ë²ˆì§¸ ë²„íŠ¼ ìƒì„±
            const btn1 = document.createElement('button');
            btn1.textContent = 'ì¼ë¶€ ì‚¬ìš©';
            btn1.className = 'action-btn';
            //ë²„íŠ¼ë§ˆë‹¤ ì´ë²¤íŠ¸ 
            btn1.onclick = (e) => {
                const shelfDiv = e.target.closest('.shelf'); // ìƒìœ„ shelf div ì°¾ê¸°
                const id = shelfDiv.getAttribute('id');   // id ê°’ ê°€ì ¸ì˜¤ê¸°
                halfUse(id);
            };

            // ë‘ ë²ˆì§¸ ë²„íŠ¼ ìƒì„±
            const btn2 = document.createElement('button');
            btn2.textContent = 'ëª¨ë‘ ì‚¬ìš©';
            btn2.className = 'action-btn';
            //ë²„íŠ¼ë§ˆë‹¤ ì´ë²¤íŠ¸ ì—°ê²°í•´ì•¼ê² ì£ ^^
            btn2.onclick = (e) => {
                const shelfDiv = e.target.closest('.shelf'); // ìƒìœ„ shelf div ì°¾ê¸°
                const id = shelfDiv.getAttribute('id');   // id ê°’ ê°€ì ¸ì˜¤ê¸°
                fullUse(id);
            };

            btnContainer.appendChild(btn1);
            btnContainer.appendChild(btn2);
            shelf.appendChild(btnContainer);
        }
        //ì¼ë¶€ì‚¬ìš© í•¨ìˆ˜
        // ëˆ„ë¥´ë©´ DBë¥¼ í†µí•´ ì‚¬ìš©íšŸìˆ˜ ì¦ê°€ ì´ë²¤íŠ¸
        function halfUse(id) {
            fetch('http://localhost:3000/ingredients/halfUse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id }), // í•­ëª© ID ì „ë‹¬
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ì¼ë¶€ ì‚¬ìš© ì²˜ë¦¬ ì™„ë£Œ!');
                    // ì¼ë¶€ ì‚¬ìš© ì²˜ë¦¬ í›„ UIì—ì„œ í•´ë‹¹ í•­ëª©ì˜ ì‚¬ìš©íšŸìˆ˜ë§Œ ê°±ì‹ 
                    const shelfDiv = document.querySelector(`.shelf[id="${id}"]`);
                    if (shelfDiv) {
                        const usageCount = shelfDiv.querySelector('.usage-count');
                        if (usageCount) {
                            let currentUses = parseInt(usageCount.textContent.replace('ì‚¬ìš©íšŸìˆ˜: ', '').replace('íšŒ', '')) || 0;
                            currentUses += 1; // ì‚¬ìš©íšŸìˆ˜ ì¦ê°€
                            usageCount.textContent = `ì‚¬ìš©íšŸìˆ˜: ${currentUses}íšŒ`;
                        }
                    }
                } else {
                    alert('ì‚¬ìš© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error updating ingredient use:', error);
                alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ì¸í•´ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            });
        }


        function fullUse(id){
            fetch('http://localhost:3000/ingredients/fullUse',{
                method:'post',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id }), // í•­ëª© ID ì „ë‹¬
                })
            .then(response => response.json())
            .then(data =>{
                if (data.success) {
                    alert('ëª¨ë‘ ì‚¬ìš© ì²˜ë¦¬ ì™„ë£Œ!');
                    // UIì—ì„œ í•´ë‹¹ í•­ëª© ì¦‰ì‹œ ì‚­ì œ
                    const shelfDiv = document.querySelector(`.shelf[id="${id}"]`);
                    if (shelfDiv) {
                        shelfDiv.remove(); // í•´ë‹¹ í•­ëª© ì‚­ì œ
                    }
                } else {
                    alert('ì‚¬ìš© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch(error => {
                console.error('Error updating ingredient use:', error);
                alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ì¸í•´ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            });
        }


        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = async function() {
        try {
            // loadIngredientsì™€ loadreceiptsë¥¼ ë³‘ë ¬ë¡œ ì‹¤í–‰
            await Promise.all([loadIngredients(), loadreceipts()]);
        } catch (error) {
            console.error('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
        };
    </script>
</body>
</html>
